esphome:
  name: book-nook-portion
  friendly_name: book-nook-portion
  on_boot:
    then:
      - light.turn_on:
          id: led1
          effect: "ruhiges Flackern"
      - light.turn_on:
          id: led2
          effect: "ruhiges Flackern"
      - light.turn_on:
          id: led3
          effect: "ruhiges Flackern"
      - light.turn_on:
          id: led4
          effect: "ruhiges Flackern"
      - light.turn_on:
          id: led5
          effect: "ruhiges Flackern"


esp8266:
  board: nodemcu

# Enable logging
logger:

# Enable Home Assistant API
api:
  encryption:
    key: "zgaW+hh3tXzLizRniNi6zSnvQPc4ulVN4a0SdHUyxTc="

ota:
  - platform: esphome
    password: "19b49a990fba75efd13d8ca035962d9a"

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password

  # Enable fallback hotspot (captive portal) in case wifi connection fails
  ap:
    ssid: "Book-Nook-Portion"
    password: "PmsuQSdpFwML"

captive_portal:

web_server:



sun:
  latitude: 50.9383Â°
  longitude: 6.9599Â°

deep_sleep:
  id: deepsleep_ctrl

time:
  - platform: sntp

interval:
  - interval: 5s
    then:
      - if:
          condition:
            sun.is_above_horizon
          then:
            - logger.log: "â˜€ï¸ Tag -> gehe schlafen"
#            - deep_sleep.enter:
#                id: deepsleep_ctrl
#                sleep_duration: 30min
          else:
            - logger.log: "ðŸŒ™ Nacht -> wach bleiben"

output:
  - platform: esp8266_pwm
    pin: GPIO12   
    frequency: 1200 Hz
    id: led1_pwm
  - platform: esp8266_pwm
    pin: GPIO13   
    frequency: 1200 Hz
    id: led2_pwm
  - platform: esp8266_pwm
    pin: GPIO4   
    frequency: 1200 Hz
    id: led3_pwm
  - platform: esp8266_pwm
    pin: GPIO5   
    frequency: 1200 Hz
    id: led4_pwm
  - platform: esp8266_pwm
    pin: GPIO14  
    frequency: 1200 Hz
    id: led5_pwm

# ------------------------------
# Lichter als Schalter anzeigen
# ------------------------------
light:
  - platform: monochromatic
    name: "LED 1"
    id: led1
    output: led1_pwm
    restore_mode: ALWAYS_ON
    default_transition_length: 1000ms
    effects:
      - lambda:
          name: "ruhiges Flackern"
          update_interval: 5100ms
          lambda: |-
            static float b = 0.6f;
            static uint32_t next = 0;
            auto now = millis();
            if (now < next) return;
            next = now + (uint32_t)(random_float() * 3000 + 2000);  // 2â€“5 s
            b += (random_float() - 0.5f) * 0.4f;                    // Â±0.2
            if (b < 0.3f) b = 0.3f;
            if (b > 1.0f) b = 1.0f;
            auto call = id(led1).turn_on();
            call.set_brightness(b);
            call.set_transition_length(1000);
            call.perform();

  - platform: monochromatic
    name: "LED 2"
    id: led2
    output: led2_pwm
    restore_mode: ALWAYS_ON
    default_transition_length: 1000ms
    effects:
      - lambda:
          name: "ruhiges Flackern"
          update_interval: 5200ms
          lambda: |-
            static float b = 0.6f;
            static uint32_t next = 0;
            auto now = millis();
            if (now < next) return;
            next = now + (uint32_t)(random_float() * 3000 + 2000);
            b += (random_float() - 0.5f) * 0.4f;
            if (b < 0.3f) b = 0.3f;
            if (b > 1.0f) b = 1.0f;
            auto call = id(led2).turn_on();
            call.set_brightness(b);
            call.set_transition_length(1000);
            call.perform();

  - platform: monochromatic
    name: "LED 3"
    id: led3
    output: led3_pwm
    restore_mode: ALWAYS_ON
    default_transition_length: 1000ms
    effects:
      - lambda:
          name: "ruhiges Flackern"
          update_interval: 5300ms
          lambda: |-
            static float b = 0.6f;
            static uint32_t next = 0;
            auto now = millis();
            if (now < next) return;
            next = now + (uint32_t)(random_float() * 3000 + 2000);
            b += (random_float() - 0.5f) * 0.4f;
            if (b < 0.3f) b = 0.3f;
            if (b > 1.0f) b = 1.0f;
            auto call = id(led3).turn_on();
            call.set_brightness(b);
            call.set_transition_length(1000);
            call.perform();

  - platform: monochromatic
    name: "LED 4"
    id: led4
    output: led4_pwm
    restore_mode: ALWAYS_ON
    default_transition_length: 1000ms
    effects:
      - lambda:
          name: "ruhiges Flackern"
          update_interval: 5400ms
          lambda: |-
            static float b = 0.6f;
            static uint32_t next = 0;
            auto now = millis();
            if (now < next) return;
            next = now + (uint32_t)(random_float() * 3000 + 2000);
            b += (random_float() - 0.5f) * 0.4f;
            if (b < 0.3f) b = 0.3f;
            if (b > 1.0f) b = 1.0f;
            auto call = id(led4).turn_on();
            call.set_brightness(b);
            call.set_transition_length(1000);
            call.perform();

  - platform: monochromatic
    name: "LED 5"
    id: led5
    output: led5_pwm
    restore_mode: ALWAYS_ON
    default_transition_length: 1000ms
    effects:
      - lambda:
          name: "ruhiges Flackern"
          update_interval: 5500ms
          lambda: |-
            static float b = 0.6f;
            static uint32_t next = 0;
            auto now = millis();
            if (now < next) return;
            next = now + (uint32_t)(random_float() * 3000 + 2000);
            b += (random_float() - 0.5f) * 0.4f;
            if (b < 0.3f) b = 0.3f;
            if (b > 1.0f) b = 1.0f;
            auto call = id(led5).turn_on();
            call.set_brightness(b);
            call.set_transition_length(1000);
            call.perform();
